<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Account</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes fadeIn { from {opacity:0; transform: translateY(10px)} to {opacity:1; transform:none} }
        .card { animation: fadeIn .3s ease-out }
    </style>
    <script>
        const API = window.location.origin;
        let currentUser = null;

        async function fetchMe() {
            const user_id = localStorage.getItem('user_id');
            const email = localStorage.getItem('email');
            const is_license_active = localStorage.getItem('is_license_active');
            
            if (!user_id || !email) { 
                window.location.href = '/login'; 
                return; 
            }
            
            // Set current user data from localStorage
            currentUser = {
                user_id: user_id,
                email: email,
                is_license_active: is_license_active === 'true'
            };
            
            // Set form values
            document.getElementById('email').value = email || '';
            
            // Set license status
            document.getElementById('keyStatus').innerHTML = (is_license_active === 'true')
                ? '<span class="text-green-700 bg-green-100 px-3 py-1 rounded-full text-xs font-semibold"><i class="fas fa-check-circle"></i> Active</span>'
                : '<span class="text-yellow-700 bg-yellow-100 px-3 py-1 rounded-full text-xs font-semibold"><i class="fas fa-exclamation-triangle"></i> No License</span>';
        }

        async function saveProfile() {
            const user_id = localStorage.getItem('user_id');
            const email = document.getElementById('email').value;
            
            // Simple validation
            if (!email) {
                alert('Email is required');
                return;
            }
            
            // Update localStorage
            localStorage.setItem('email', email);
            alert('Profile updated successfully!');
        }

        async function changePassword() {
            // For now, just show message - implement backend later
            alert('Password change functionality will be implemented soon!');
        }

        async function deleteAccount() {
            if (!confirm('This will permanently delete your account. Continue?')) return;
            const token = localStorage.getItem('access_token');
            const res = await fetch('/user/delete', { method:'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
            if (res.ok) {
                try { await fetch('/logout', { method: 'POST' }); } catch(e) {}
                localStorage.clear();
                alert('Account deleted');
                window.location.href = '/signup';
            } else {
                const data = await res.json();
                alert(data.detail || 'Failed to delete');
            }
        }

        async function logout() {
            try { await fetch('/logout', { method: 'POST' }); } catch(e) {}
            localStorage.clear();
            window.location.href = '/login';
        }

        document.addEventListener('DOMContentLoaded', fetchMe);
    </script>
</head>
<body class="bg-slate-50 min-h-screen">
    <nav class="bg-slate-900 text-white shadow">
        <div class="container mx-auto px-6 h-16 flex items-center justify-between">
            <a href="/" class="font-bold">‚Üê Back to Home</a>
            <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">Logout</button>
        </div>
    </nav>

    <main class="container mx-auto px-6 py-8 grid grid-cols-1 md:grid-cols-2 gap-6">
        <section class="bg-white rounded-xl shadow p-6 card">
            <h2 class="font-bold text-lg mb-4 flex items-center gap-2"><i class="fas fa-user"></i> Profile</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-sm text-gray-600">Username</label>
                    <input id="username" class="w-full border rounded px-3 py-2" placeholder="Enter username (optional)" />
                </div>
                <div>
                    <label class="text-sm text-gray-600">Email</label>
                    <input id="email" class="w-full border rounded px-3 py-2" placeholder="email" />
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-gray-600">Activation</span>
                    <div id="keyStatus"></div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="saveProfile()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save</button>
                    <a href="/" class="px-4 py-2 rounded border">Cancel</a>
                </div>
            </div>
        </section>

        <section class="bg-white rounded-xl shadow p-6 card">
            <h2 class="font-bold text-lg mb-4 flex items-center gap-2"><i class="fas fa-lock"></i> Security</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-sm text-gray-600">Current Password</label>
                    <input id="curPass" type="password" class="w-full border rounded px-3 py-2" />
                </div>
                <div>
                    <label class="text-sm text-gray-600">New Password</label>
                    <input id="newPass" type="password" class="w-full border rounded px-3 py-2" placeholder="Min 8 chars, upper/lower/digit/special" />
                </div>
                <button onclick="changePassword()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Change Password</button>
                <hr class="my-4" />
                <button onclick="deleteAccount()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Delete Account</button>
            </div>
        </section>
    </main>
</body>
</html>