<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard - User Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    .notification {
      animation: slideIn 0.3s ease-out;
    }
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    .stat-card {
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .gradient-green {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    .gradient-orange {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    .gradient-purple {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    }
    .gradient-blue {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    .shimmer {
      background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 50%, #f3f4f6 100%);
      background-size: 1000px 100%;
      animation: shimmer 2s infinite;
    }
    .tooltip {
      position: relative;
    }
    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 0.5rem;
      border-radius: 0.375rem;
      white-space: nowrap;
      font-size: 0.875rem;
      z-index: 1000;
      margin-bottom: 0.5rem;
    }
    .table-row {
      transition: all 0.2s ease;
    }
    .table-row:hover {
      background-color: #f9fafb;
      transform: scale(1.01);
    }
    .badge-pulse {
      animation: pulse 2s infinite;
    }
  </style>
</head>

<body class="bg-gray-100">
  <!-- Top Navigation Bar -->
  <nav class="gradient-bg text-white shadow-2xl">
    <div class="mx-auto px-6 py-4 flex justify-between items-center">
      <div class="flex items-center gap-4">
        <div class="bg-white p-2 rounded-lg shadow-lg">
          <img src="/logo.png" alt="Logo" class="h-10 w-auto" />
        </div>
        <div>
          <h1 class="text-2xl font-bold flex items-center gap-2">
            <i class="fas fa-shield-halved"></i>
            Admin Control Panel
          </h1>
          <p class="text-xs text-blue-200">User Management System</p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-right">
          <div id="adminName" class="text-sm font-medium"></div>
          <div id="currentTime" class="text-xs text-blue-200"></div>
        </div>
        <a href="/" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-medium shadow-lg transition flex items-center gap-2">
          <i class="fas fa-home"></i> Home
        </a>
        <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm font-medium shadow-lg transition flex items-center gap-2">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="mx-auto max-w-7xl mt-6 p-4">
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="stat-card bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500 fade-in">
        <div class="flex justify-between items-start">
          <div>
            <div class="text-gray-500 text-sm font-medium mb-2">Total Users</div>
            <div id="totalUsers" class="text-4xl font-bold text-blue-600">0</div>
            <div class="text-xs text-gray-400 mt-1">Registered accounts</div>
          </div>
          <div class="gradient-blue p-3 rounded-lg">
            <i class="fas fa-users text-white text-2xl"></i>
          </div>
        </div>
      </div>
      
      <div class="stat-card bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500 fade-in" style="animation-delay: 0.1s">
        <div class="flex justify-between items-start">
          <div>
            <div class="text-gray-500 text-sm font-medium mb-2">Active Users</div>
            <div id="usersWithKeys" class="text-4xl font-bold text-green-600">0</div>
            <div class="text-xs text-gray-400 mt-1">With activation keys</div>
          </div>
          <div class="gradient-green p-3 rounded-lg">
            <i class="fas fa-user-check text-white text-2xl"></i>
          </div>
        </div>
      </div>
      
      <div class="stat-card bg-white p-6 rounded-xl shadow-lg border-l-4 border-orange-500 fade-in" style="animation-delay: 0.2s">
        <div class="flex justify-between items-start">
          <div>
            <div class="text-gray-500 text-sm font-medium mb-2">Pending Users</div>
            <div id="usersWithoutKeys" class="text-4xl font-bold text-orange-600">0</div>
            <div class="text-xs text-gray-400 mt-1">Awaiting activation</div>
          </div>
          <div class="gradient-orange p-3 rounded-lg">
            <i class="fas fa-user-clock text-white text-2xl"></i>
          </div>
        </div>
      </div>
      
      <div class="stat-card bg-white p-6 rounded-xl shadow-lg border-l-4 border-purple-500 fade-in" style="animation-delay: 0.3s">
        <div class="flex justify-between items-start">
          <div>
            <div class="text-gray-500 text-sm font-medium mb-2">Total Keys</div>
            <div id="totalKeys" class="text-4xl font-bold text-purple-600">0</div>
            <div class="text-xs text-gray-400 mt-1">Generated & assigned</div>
          </div>
          <div class="gradient-purple p-3 rounded-lg">
            <i class="fas fa-key text-white text-2xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons & Search -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
      <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
        <div class="flex flex-wrap gap-3">
          <button onclick="openGenerateKeyModal()" class="gradient-green text-white px-6 py-3 rounded-lg font-medium shadow-lg hover:shadow-xl transition flex items-center gap-2">
            <i class="fas fa-plus-circle"></i> Generate Key
          </button>
          <button onclick="loadUsers()" class="gradient-blue text-white px-6 py-3 rounded-lg font-medium shadow-lg hover:shadow-xl transition flex items-center gap-2">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <button onclick="exportUsers()" class="bg-gray-700 hover:bg-gray-800 text-white px-6 py-3 rounded-lg font-medium shadow-lg hover:shadow-xl transition flex items-center gap-2">
            <i class="fas fa-download"></i> Export CSV
          </button>
        </div>
        <div class="flex-grow max-w-md relative">
          <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          <input 
            type="text" 
            id="searchInput" 
            placeholder="Search by username, email, or key..." 
            class="w-full border-2 border-gray-200 focus:border-blue-500 pl-12 pr-4 py-3 rounded-lg transition outline-none" 
            onkeyup="filterUsers()">
        </div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="bg-white rounded-xl shadow-xl overflow-hidden">
      <div class="bg-gradient-to-r from-gray-800 to-gray-900 px-6 py-4">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
          <i class="fas fa-table"></i> User Management
        </h2>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50 border-b-2 border-gray-200">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                <i class="fas fa-hashtag mr-1"></i> ID
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                <i class="fas fa-user mr-1"></i> Username
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                <i class="fas fa-envelope mr-1"></i> Email
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                <i class="fas fa-key mr-1"></i> Activation Key
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                <i class="fas fa-circle-check mr-1"></i> Status
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                <i class="fas fa-calendar mr-1"></i> Created
              </th>
              <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                <i class="fas fa-cog mr-1"></i> Actions
              </th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr>
              <td colspan="7" class="px-6 py-12 text-center">
                <div class="shimmer h-12 rounded mb-2"></div>
                <div class="shimmer h-12 rounded mb-2"></div>
                <div class="shimmer h-12 rounded"></div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Generate Key Modal -->
  <div id="generateKeyModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl transform transition-all">
      <div class="flex items-center gap-3 mb-6">
        <div class="gradient-green p-3 rounded-xl">
          <i class="fas fa-key text-white text-2xl"></i>
        </div>
        <div>
          <h2 class="text-2xl font-bold text-gray-800">Generate Activation Key</h2>
          <p class="text-sm text-gray-500">Create a new activation key for users</p>
        </div>
      </div>
      
      <div class="space-y-5">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            <i class="fas fa-user text-blue-500 mr-1"></i> User ID (Optional)
          </label>
          <input 
            type="number" 
            id="keyUserId" 
            class="w-full border-2 border-gray-200 focus:border-blue-500 rounded-xl px-4 py-3 transition outline-none" 
            placeholder="Leave empty for unassigned key">
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            <i class="fas fa-code text-purple-500 mr-1"></i> Key Code (Optional)
          </label>
          <input 
            type="text" 
            id="keyCode" 
            class="w-full border-2 border-gray-200 focus:border-blue-500 rounded-xl px-4 py-3 transition outline-none font-mono" 
            placeholder="Auto-generated if empty">
          <p class="text-xs text-gray-500 mt-1">Format: XXXX-XXXX-XXXX-XXXX</p>
        </div>
        
        <div class="flex gap-3 mt-6">
          <button onclick="generateKey()" class="flex-1 gradient-green text-white px-6 py-3 rounded-xl font-medium shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2">
            <i class="fas fa-magic"></i> Generate
          </button>
          <button onclick="closeGenerateKeyModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-xl font-medium transition">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assign Key Modal -->
  <div id="assignKeyModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl transform transition-all">
      <div class="flex items-center gap-3 mb-6">
        <div class="gradient-blue p-3 rounded-xl">
          <i class="fas fa-link text-white text-2xl"></i>
        </div>
        <div>
          <h2 class="text-2xl font-bold text-gray-800">Assign Activation Key</h2>
          <p class="text-sm text-gray-500">Link a key to activate user account</p>
        </div>
      </div>
      
      <div class="space-y-5">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            <i class="fas fa-key text-blue-500 mr-1"></i> Available Keys
          </label>
          <select id="availableKeys" class="w-full border-2 border-gray-200 focus:border-blue-500 rounded-xl px-4 py-3 transition outline-none font-mono">
            <option value="">Loading available keys...</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">Only unused keys are shown</p>
        </div>
        
        <div class="flex gap-3 mt-6">
          <button onclick="assignKey()" class="flex-1 gradient-blue text-white px-6 py-3 rounded-xl font-medium shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2">
            <i class="fas fa-check"></i> Assign Key
          </button>
          <button onclick="closeAssignKeyModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-xl font-medium transition">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let allUsers = [];
    let currentAssignUserId = null;

    // Update current time
    function updateTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      const dateString = now.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
      document.getElementById('currentTime').textContent = `${dateString} ‚Ä¢ ${timeString}`;
    }

    // Check admin authentication
    async function checkAuth() {
      const token = localStorage.getItem('access_token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/admin/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error('Not authorized');
        }

        const data = await response.json();
        document.getElementById('adminName').textContent = `üëë ${data.username}`;
        
        // Start time update
        updateTime();
        setInterval(updateTime, 1000);
      } catch (error) {
        showNotification('Admin access required!', 'error');
        setTimeout(() => window.location.href = '/login.html', 2000);
      }
    }

    // Show notification
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-xl text-white z-50 notification ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
      }`;
      notification.innerHTML = `
        <div class="flex items-center gap-3">
          <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} text-2xl"></i>
          <span class="font-medium">${message}</span>
        </div>
      `;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(120%)';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Load all users
    async function loadUsers() {
      const token = localStorage.getItem('access_token');
      try {
        const response = await fetch(`${API_BASE}/admin/users`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load users');

        allUsers = await response.json();
        displayUsers(allUsers);
        updateStats();
      } catch (error) {
        console.error('Error loading users:', error);
        alert('Failed to load users');
      }
    }

    // Display users in table
    function displayUsers(users) {
      const tbody = document.getElementById('usersTableBody');
      const totalAdmins = allUsers.filter(u => u.is_admin).length;
      
      if (users.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="px-6 py-12 text-center">
              <i class="fas fa-users text-gray-300 text-6xl mb-4"></i>
              <p class="text-gray-500 text-lg font-medium">No users found</p>
              <p class="text-gray-400 text-sm">Try adjusting your search criteria</p>
            </td>
          </tr>`;
        return;
      }

      tbody.innerHTML = users.map((user, index) => `
        <tr class="table-row border-b border-gray-100" style="animation: fadeIn 0.3s ease-out ${index * 0.05}s both">
          <td class="px-6 py-4">
            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600 font-bold text-sm">
              ${user.id}
            </span>
          </td>
          <td class="px-6 py-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full gradient-bg flex items-center justify-center text-white font-bold">
                ${user.username.charAt(0).toUpperCase()}
              </div>
              <div>
                <div class="font-medium text-gray-900">${user.username}</div>
                ${user.is_admin ? '<span class="text-xs text-purple-600 font-medium"><i class="fas fa-crown"></i> Admin</span>' : ''}
              </div>
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="flex items-center gap-2 text-gray-600">
              <i class="fas fa-envelope text-gray-400"></i>
              <span class="text-sm">${user.email || 'N/A'}</span>
            </div>
          </td>
          <td class="px-6 py-4">
            ${user.activation_key 
              ? `<div class="tooltip" data-tooltip="Click to copy">
                   <code class="bg-green-50 text-green-700 px-3 py-2 rounded-lg text-xs font-mono cursor-pointer hover:bg-green-100 transition" 
                         onclick="copyToClipboard('${user.activation_key}')">${user.activation_key}</code>
                 </div>` 
              : '<span class="text-gray-400 text-sm italic">No key assigned</span>'}
          </td>
          <td class="px-6 py-4">
            ${user.activation_key 
              ? '<span class="inline-flex items-center gap-2 bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-medium"><i class="fas fa-check-circle"></i> Active</span>' 
              : '<span class="inline-flex items-center gap-2 bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-medium badge-pulse"><i class="fas fa-clock"></i> Pending</span>'}
          </td>
          <td class="px-6 py-4 text-sm text-gray-500">
            <div class="flex items-center gap-2">
              <i class="fas fa-calendar-alt text-gray-400"></i>
              ${formatDate(user.created_at)}
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="flex justify-center gap-2 flex-wrap">
              ${!user.activation_key && !user.is_admin
                ? `<button onclick="openAssignKeyModal(${user.id})" 
                           class="tooltip bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-medium shadow-md hover:shadow-lg transition flex items-center gap-1"
                           data-tooltip="Assign Key">
                     <i class="fas fa-key"></i> Assign
                   </button>` 
                : user.activation_key && !user.is_admin
                ? `<button onclick="revokeKey(${user.id})" 
                           class="tooltip bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-xs font-medium shadow-md hover:shadow-lg transition flex items-center gap-1"
                           data-tooltip="Revoke Key">
                     <i class="fas fa-ban"></i> Revoke
                   </button>`
                : ''}
              ${user.is_admin
                ? `${totalAdmins > 1 
                      ? `<button onclick=\"demoteUser(${user.id})\" class=\"tooltip bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-xs font-medium shadow-md hover:shadow-lg transition flex items-center gap-1\" data-tooltip=\"Remove admin\"><i class=\"fas fa-user-minus\"></i> Demote</button>`
                      : `<span class=\"text-xs text-gray-400 italic\">Last admin</span>`}`
                : `<button onclick=\"promoteUser(${user.id})\" class=\"tooltip bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-xs font-medium shadow-md hover:shadow-lg transition flex items-center gap-1\" data-tooltip=\"Make admin\"><i class=\"fas fa-user-plus\"></i> Promote</button>`}

              ${user.is_admin
                ? `${totalAdmins > 1 
                      ? `<button onclick=\"deleteUser(${user.id})\" class=\"tooltip bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-xs font-medium shadow-md hover:shadow-lg transition flex items-center gap-1\" data-tooltip=\"Delete Admin\"><i class=\"fas fa-trash\"></i> Delete</button>`
                      : `<span class=\"text-xs text-gray-400 italic\">Cannot delete last admin</span>`}`
                : `<button onclick=\"deleteUser(${user.id})\" class=\"tooltip bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-xs font-medium shadow-md hover:shadow-lg transition flex items-center gap-1\" data-tooltip=\"Delete User\"><i class=\"fas fa-trash\"></i> Delete</button>`}
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffTime = Math.abs(now - date);
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    // Copy to clipboard
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showNotification('Key copied to clipboard!', 'success');
      });
    }

    // Export users to CSV
    function exportUsers() {
      const csv = ['ID,Username,Email,Activation Key,Status,Created At'].concat(
        allUsers.map(u => `${u.id},${u.username},${u.email || ''},${u.activation_key || ''},${u.activation_key ? 'Active' : 'Inactive'},${u.created_at}`)
      ).join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      showNotification('Users exported successfully!', 'success');
    }

    // Update statistics
    function updateStats() {
      const total = allUsers.length;
      const withKeys = allUsers.filter(u => u.activation_key).length;
      const withoutKeys = total - withKeys;

      document.getElementById('totalUsers').textContent = total;
      document.getElementById('usersWithKeys').textContent = withKeys;
      document.getElementById('usersWithoutKeys').textContent = withoutKeys;
      document.getElementById('totalKeys').textContent = withKeys;
    }

    // Filter users by search
    function filterUsers() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const filtered = allUsers.filter(user => 
        user.username.toLowerCase().includes(search) ||
        (user.email && user.email.toLowerCase().includes(search)) ||
        (user.activation_key && user.activation_key.toLowerCase().includes(search))
      );
      displayUsers(filtered);
    }

    // Generate new key
    async function generateKey() {
      const token = localStorage.getItem('access_token');
      const userId = document.getElementById('keyUserId').value;
      const keyCode = document.getElementById('keyCode').value;

      try {
        const response = await fetch(`${API_BASE}/admin/generate-key`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            user_id: userId ? parseInt(userId) : null,
            key_code: keyCode || null
          })
        });

        if (!response.ok) throw new Error('Failed to generate key');

        const data = await response.json();
        showNotification(`Key generated: ${data.activation_key}`, 'success');
        closeGenerateKeyModal();
        loadUsers();
      } catch (error) {
        console.error('Error generating key:', error);
        showNotification('Failed to generate key', 'error');
      }
    }

    // Open assign key modal
    async function openAssignKeyModal(userId) {
      currentAssignUserId = userId;
      const token = localStorage.getItem('access_token');

      try {
        const response = await fetch(`${API_BASE}/admin/available-keys`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load keys');

        const keys = await response.json();
        const select = document.getElementById('availableKeys');
        
        if (keys.length === 0) {
          select.innerHTML = '<option value="">No available keys - Generate one first</option>';
        } else {
          select.innerHTML = '<option value="">Select a key...</option>' +
            keys.map(key => `<option value="${key.activation_key}">${key.activation_key}</option>`).join('');
        }

        document.getElementById('assignKeyModal').classList.remove('hidden');
      } catch (error) {
        console.error('Error loading keys:', error);
        alert('Failed to load available keys');
      }
    }

    // Assign key to user
    async function assignKey() {
      const token = localStorage.getItem('access_token');
      const keyValue = document.getElementById('availableKeys').value;

      if (!keyValue) {
        showNotification('Please select a key', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/admin/assign-key`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            user_id: currentAssignUserId,
            activation_key: keyValue
          })
        });

        if (!response.ok) throw new Error('Failed to assign key');

        showNotification('Key assigned successfully!', 'success');
        closeAssignKeyModal();
        loadUsers();
      } catch (error) {
        console.error('Error assigning key:', error);
        showNotification('Failed to assign key', 'error');
      }
    }

    // Revoke key from user
    async function revokeKey(userId) {
      if (!confirm('‚ö†Ô∏è Revoke Activation Key?\n\nThis will deactivate the user\'s account. The key can be reassigned later.')) return;

      const token = localStorage.getItem('access_token');
      try {
        const response = await fetch(`${API_BASE}/admin/revoke-key/${userId}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to revoke key');

        showNotification('Key revoked successfully!', 'success');
        loadUsers();
      } catch (error) {
        console.error('Error revoking key:', error);
        showNotification('Failed to revoke key', 'error');
      }
    }

    // Promote user to admin
    async function promoteUser(userId) {
      const token = localStorage.getItem('access_token');
      try {
        const res = await fetch(`${API_BASE}/admin/promote/${userId}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }});
        if (!res.ok) throw new Error();
        showNotification('User promoted to admin', 'success');
        loadUsers();
      } catch (e) { showNotification('Failed to promote user', 'error'); }
    }

    // Demote admin to user
    async function demoteUser(userId) {
      const token = localStorage.getItem('access_token');
      try {
        const res = await fetch(`${API_BASE}/admin/demote/${userId}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }});
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Failed');
        showNotification('Admin demoted', 'success');
        loadUsers();
      } catch (e) { showNotification('Failed to demote admin', 'error'); }
    }

    // Delete user
    async function deleteUser(userId) {
      if (!confirm('üóëÔ∏è Delete User Permanently?\n\nThis action CANNOT be undone!\n\nThe user and all their data will be deleted.')) return;

      const token = localStorage.getItem('access_token');
      try {
        const response = await fetch(`${API_BASE}/admin/users/${userId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to delete user');

        showNotification('User deleted successfully!', 'success');
        loadUsers();
      } catch (error) {
        console.error('Error deleting user:', error);
        showNotification('Failed to delete user', 'error');
      }
    }

    // Modal functions
    function openGenerateKeyModal() {
      document.getElementById('keyUserId').value = '';
      document.getElementById('keyCode').value = '';
      document.getElementById('generateKeyModal').classList.remove('hidden');
    }

    function closeGenerateKeyModal() {
      document.getElementById('generateKeyModal').classList.add('hidden');
    }

    function closeAssignKeyModal() {
      document.getElementById('assignKeyModal').classList.add('hidden');
      currentAssignUserId = null;
    }

    // Logout
    async function logout() {
      try { await fetch(`${API_BASE}/logout`, { method: 'POST' }); } catch(e) {}
      localStorage.removeItem('access_token');
      window.location.href = '/login.html';
    }

    // Initialize
    checkAuth();
    loadUsers();
  </script>
</body>
</html>
