<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Braking Performance Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body class="bg-gray-100">

  <nav class="bg-blue-900 text-white shadow-lg mb-6">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <a href="/" class="flex items-center gap-2">
          <img src="/logo.png" alt="Logo" class="h-10 bg-white rounded p-1">
          <span class="font-bold text-xl">Premnath Engineering</span>
      </a>
      <a href="/" class="hover:text-gray-300">Home</a>
    </div>
  </nav>

  <div class="max-w-6xl mx-auto px-4 pb-10">
    <header class="bg-blue-800 text-white p-4 rounded-t-xl flex items-center gap-3">
      <span class="text-2xl">ðŸ›‘</span>
      <h1 class="text-xl font-bold">BRAKING PERFORMANCE CALCULATOR (EN 15746-2)</h1>
    </header>

    <div class="bg-white p-6 rounded-b-xl shadow-lg border border-gray-200">
      
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
        <div><label class="text-xs font-bold text-gray-500">Doc No</label><input id="doc_no" value="DOC-001" class="w-full border p-1 rounded"></div>
        <div><label class="text-xs font-bold text-gray-500">Made By</label><input id="made_by" value="Engineer" class="w-full border p-1 rounded"></div>
        <div><label class="text-xs font-bold text-gray-500">Checked By</label><input id="checked_by" value="Manager" class="w-full border p-1 rounded"></div>
        <div><label class="text-xs font-bold text-gray-500">Approved By</label><input id="approved_by" value="Director" class="w-full border p-1 rounded"></div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <div class="space-y-6">
          
          <section class="border rounded-lg p-4 relative">
            <h2 class="absolute -top-3 left-4 bg-white px-2 text-blue-800 font-bold text-sm">1. Vehicle Data</h2>
            <div class="grid grid-cols-2 gap-4 mt-2">
              <label class="block text-sm font-medium text-gray-700">GVW (kg)
                <input type="number" id="mass_kg" value="18000" class="w-full border p-2 rounded mt-1">
              </label>
              <label class="block text-sm font-medium text-gray-700">Max Speed (km/h)
                <input type="number" id="speed_kmh" value="40" class="w-full border p-2 rounded mt-1">
              </label>
              <label class="block text-sm font-medium text-gray-700">Total Wheels
                <input type="number" id="number_of_wheels" value="4" class="w-full border p-2 rounded mt-1">
              </label>
              <label class="block text-sm font-medium text-gray-700">Wheel Dia (mm)
                <input type="number" id="wheel_dia" value="850" class="w-full border p-2 rounded mt-1">
              </label>
            </div>
          </section>

          <section class="border rounded-lg p-4 relative">
            <h2 class="absolute -top-3 left-4 bg-white px-2 text-blue-800 font-bold text-sm">2. Track Data</h2>
            <div class="space-y-3 mt-2">
              <div class="grid grid-cols-2 gap-2">
                 <label class="block text-sm font-medium text-gray-700">Gradient Input
                    <input type="number" id="gradient_input" value="40" class="w-full border p-2 rounded mt-1">
                 </label>
                 <label class="block text-sm font-medium text-gray-700">Unit
                    <select id="gradient_type" class="w-full border p-2 rounded mt-1 bg-white">
                        <option value="1 in G">1 in G</option>
                        <option value="Degree (Â°)">Degree (Â°)</option>
                        <option value="Percentage (%)">Percentage (%)</option>
                    </select>
                 </label>
              </div>
            </div>
          </section>

          <section class="border rounded-lg p-4 relative">
            <h2 class="absolute -top-3 left-4 bg-white px-2 text-blue-800 font-bold text-sm">3. Calculation Settings</h2>
            <div class="space-y-3 mt-2">
                <div class="flex items-center gap-4">
                    <span class="text-sm font-medium">Distance Source:</span>
                    <label class="inline-flex items-center"><input type="radio" name="dist_src" value="EN Standard" checked class="form-radio"> <span class="ml-1 text-sm">EN Standard</span></label>
                    <label class="inline-flex items-center"><input type="radio" name="dist_src" value="Custom" class="form-radio"> <span class="ml-1 text-sm">Custom</span></label>
                </div>
                <div id="custom_dist_div" class="hidden">
                     <label class="block text-sm font-medium text-gray-700">Custom Stop Distance (m)
                        <input type="number" id="custom_distance" class="w-full border p-2 rounded mt-1">
                     </label>
                </div>
            </div>
          </section>

          <div class="flex gap-4">
              <button onclick="calculate()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded shadow transition">CALCULATE</button>
              <button onclick="downloadReport()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded shadow transition">DOWNLOAD PDF</button>
          </div>
        </div>

        <div class="space-y-6">
            <section class="border-2 border-blue-100 bg-blue-50 rounded-lg p-4 h-full">
                <h2 class="text-lg font-bold text-blue-900 mb-4">Calculation Results</h2>
                <div id="results_area" class="space-y-4 text-sm">
                    <p class="text-gray-500 italic">Click 'Calculate' to see results.</p>
                </div>
            </section>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.querySelectorAll('input[name="dist_src"]').forEach(elem => {
        elem.addEventListener("change", function(event) {
            const customDiv = document.getElementById("custom_dist_div");
            if (event.target.value === "Custom") {
                customDiv.classList.remove("hidden");
            } else {
                customDiv.classList.add("hidden");
            }
        });
    });

    function collectData() {
        return {
            doc_no: document.getElementById('doc_no').value,
            made_by: document.getElementById('made_by').value,
            checked_by: document.getElementById('checked_by').value,
            approved_by: document.getElementById('approved_by').value,
            mass_kg: parseFloat(document.getElementById('mass_kg').value),
            speed_kmh: parseFloat(document.getElementById('speed_kmh').value),
            number_of_wheels: parseInt(document.getElementById('number_of_wheels').value),
            wheel_dia: parseFloat(document.getElementById('wheel_dia').value),
            gradient_input: parseFloat(document.getElementById('gradient_input').value),
            gradient_type: document.getElementById('gradient_type').value,
            distance_source: document.querySelector('input[name="dist_src"]:checked').value,
            custom_distance: parseFloat(document.getElementById('custom_distance').value) || 0
        };
    }

    async function calculate() {
        const data = collectData();
        const resArea = document.getElementById('results_area');
        resArea.innerHTML = "Calculating...";

        try {
            const response = await fetch('/calculate_braking', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error(await response.text());
            const result = await response.json();

            let html = `
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-white p-3 rounded shadow-sm">
                        <p class="text-gray-500">Max Braking Force</p>
                        <p class="text-xl font-bold text-blue-800">${result.f_b} N</p>
                    </div>
                    <div class="bg-white p-3 rounded shadow-sm">
                        <p class="text-gray-500">Gradient Angle</p>
                        <p class="text-xl font-bold text-blue-800">${result.angle_deg}Â°</p>
                    </div>
                </div>
                <h3 class="font-bold mb-2 border-b">Scenarios at Max Speed</h3>
            `;

            const scenarios = [
                {key: 'flat', label: 'Flat Track'},
                {key: 'up', label: 'Moving Up (+Grade)'},
                {key: 'down', label: 'Moving Down (-Grade)'}
            ];

            scenarios.forEach(scen => {
                const r = result.scenarios[scen.key];
                let complianceClass = r.compliance.includes("âœ“") ? "text-green-600" : "text-red-600";
                
                html += `
                    <div class="mb-3 bg-white p-3 rounded border">
                        <h4 class="font-bold text-gray-700">${scen.label}</h4>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 mt-1 text-xs">
                            <span>Net Force: <b>${r.f_net} N</b></span>
                            <span>Decel: <b>${r.decel} m/sÂ²</b></span>
                            <span>Braking Dist: <b>${r.dist} m</b></span>
                            <span>Total Stop: <b>${r.total} m</b></span>
                        </div>
                        <p class="mt-2 font-bold ${complianceClass}">${r.compliance}</p>
                    </div>
                `;
            });
            resArea.innerHTML = html;
        } catch (err) {
            resArea.innerHTML = `<p class="text-red-600 font-bold">Error: ${err.message}</p>`;
        }
    }

    async function downloadReport() {
        const data = collectData();
        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = "GENERATING...";
        btn.disabled = true;

        try {
            const response = await fetch('/download_braking_report', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "Braking_Report.pdf";
                document.body.appendChild(a);
                a.click();
                a.remove();
            } else {
                const err = await response.json();
                alert("Error generating PDF: " + (err.detail || "Unknown error"));
            }
        } catch (error) {
            alert("Network error: " + error);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
  </script>
</body>
</html>