<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vehicle Performance Calculation System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
</head>

<body class="bg-gray-100">
  <input type="file" id="csvFileInput" accept=".csv" class="hidden" />

  <nav class="bg-blue-900 text-white shadow-lg">
    <div class="mx-auto px-4">
      <div class="flex justify-between">
        <div class="flex space-x-7">
          <div>
            <a href="/" class="flex items-center py-2 px-2 shrink-0">
              <img src="/logo.png" alt="Logo" class="h-12 w-auto mr-2" />
            </a>
          </div>
          <div class="hidden md:flex items-center space-x-1">
            <a href="/" class="py-4 px-2 text-gray-300 font-semibold hover:text-white transition duration-300">Home</a>
            <a href="/calculator" class="py-4 px-2 text-gray-300 font-semibold hover:text-white transition duration-300">Hydraulic</a>
            <a href="/qmax" class="py-4 px-2 text-gray-300 font-semibold hover:text-white transition duration-300">Qmax</a>
            <a href="/load_distribution" class="py-4 px-2 text-gray-300 font-semibold hover:text-white transition duration-300">Load Distribution</a>
            <a href="/tractive_effort" class="py-4 px-2 text-gray-300 font-semibold hover:text-white transition duration-300">Tractive Effort</a>
            <a href="/vehicle_performance" class="py-4 px-2 text-white bg-blue-800 font-semibold">Vehicle Performance</a>
            <a href="/braking" class="py-4 px-2 text-gray-300 font-semibold hover:text-white transition duration-300">Braking</a>
          </div>
        </div>
        
        <div class="md:hidden flex items-center">
          <button class="outline-none mobile-menu-button">
            <svg class="w-6 h-6 text-gray-300 hover:text-white" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor">
              <path d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
    <div class="hidden mobile-menu">
      <ul class="">
        <li><a href="/" class="block text-sm px-2 py-4 hover:bg-blue-800 transition duration-300">Home</a></li>
        <li><a href="/calculator" class="block text-sm px-2 py-4 hover:bg-blue-800 transition duration-300">Hydraulic</a></li>
        <li><a href="/qmax" class="block text-sm px-2 py-4 hover:bg-blue-800 transition duration-300">Qmax</a></li>
        <li><a href="/load_distribution" class="block text-sm px-2 py-4 hover:bg-blue-800 transition duration-300">Load Distribution</a></li>
        <li><a href="/tractive_effort" class="block text-sm px-2 py-4 hover:bg-blue-800 transition duration-300">Tractive Effort</a></li>
        <li class="active"><a href="/vehicle_performance" class="block text-sm px-2 py-4 text-white bg-blue-800 font-semibold">Vehicle Performance</a></li>
        <li><a href="/braking" class="block text-sm px-2 py-4 hover:bg-blue-800 transition duration-300">Braking</a></li>
      </ul>
    </div>
    <script>
      const btn = document.querySelector("button.mobile-menu-button");
      const menu = document.querySelector(".mobile-menu");
      btn.addEventListener("click", () => {
        menu.classList.toggle("hidden");
      });
    </script>
  </nav>
  
  <div id="main-content" class="mx-auto max-w-screen-2xl mt-4 p-4 bg-white rounded-xl shadow-lg"> 
    <header class="bg-blue-900 text-white py-3 px-4 rounded-t-xl flex flex-wrap justify-between items-center gap-3">
      <div class="flex items-center gap-3"><span class="text-2xl">ðŸ“ˆ</span><h1 class="text-xl font-bold">VEHICLE PERFORMANCE CALCULATOR</h1></div>
      <div class="flex gap-2 flex-wrap">
        <button id="importInputsBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-md text-sm font-semibold">Import Inputs (CSV)</button>
        <button id="exportInputsBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-sm font-semibold">Export Inputs (CSV)</button>
      </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">

        <div class="flex flex-col gap-4">
            <section class="border-2 border-green-500 rounded-xl p-3">
              <h2 class="bg-green-600 text-white text-center rounded-md py-1 mb-2 font-semibold">TRACK DATA</h2>
              <div class="grid grid-cols-1 gap-3">
                <div class="grid grid-cols-2 gap-2">
                    <label>Max Curve:
                        <input class="input" id="max_curve" value="5" type="number" data-export-key="max_curve" data-export-section="track" />
                    </label>
                    <label>Unit:
                        <select id="curve_unit" class="input" data-export-key="curve_unit" data-export-section="track">
                            <option value="degree">degree</option>
                            <option value="m">m (radius)</option>
                        </select>
                    </label>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <label>Max Slope:
                        <input class="input" id="max_slope" value="3.5" type="number" data-export-key="max_slope" data-export-section="track" />
                    </label>
                    <label>Unit:
                        <select id="slope_unit" class="input" data-export-key="slope_unit" data-export-section="track">
                            <option value="%">%</option>
                            <option value="degree">degree</option>
                        </select>
                    </label>
                </div>
              </div>
            </section>
            
            <section class="border-2 border-blue-600 rounded-xl p-3">
              <h2 class="bg-blue-600 text-white text-center rounded-md py-1 mb-2 font-semibold">VEHICLE DATA</h2>
              <div class="grid grid-cols-1 gap-3">
                <label>Loco GVW (kg):
                    <input class="input" id="loco_gvw" value="11000" type="number" data-export-key="loco_gvw" data-export-section="vehicle" />
                </label>
                <label>Max speed (km/h):
                    <input class="input" id="max_speed" value="60" type="number" data-export-key="max_speed" data-export-section="vehicle" />
                </label>
                <label>Number of Axles:
                    <input class="input" id="num_axles" value="2" type="number" data-export-key="num_axles" data-export-section="vehicle" />
                </label>
                <label>Rear Axle Ratio:
                    <input class="input" id="rear_axle_ratio" value="1.0" type="number" data-export-key="rear_axle_ratio" data-export-section="vehicle" />
                </label>
                <label>Gear Ratios (comma-sep):
                    <input class="input" id="gear_ratios" value="15" type="text" data-export-key="gear_ratios" data-export-section="vehicle" />
                </label>
                <label>Shunting Load (tons):
                    <input class="input" id="shunting_load" value="0" type="number" data-export-key="shunting_load" data-export-section="vehicle" />
                </label>
              </div>
            </section>

            <section class="border-2 border-orange-400 rounded-xl p-3">
              <h2 class="bg-orange-500 text-white text-center rounded-md py-1 mb-2 font-semibold">RRV DATA</h2>
              <div class="grid grid-cols-1 gap-3">
                <label>Peak Power (kW):
                    <input class="input" id="peak_power" value="90" type="number" data-export-key="peak_power" data-export-section="rrv" />
                </label>
                <label>Coeff. of Friction (mu):
                    <input class="input" id="friction_mu" value="0.3" type="number" data-export-key="friction_mu" data-export-section="rrv" />
                </label>
                <label>Wheel Dia (m):
                    <input class="input" id="wheel_dia" value="0.73" type="number" data-export-key="wheel_dia" data-export-section="rrv" />
                </label>
                <label>Min RPM:
                    <input class="input" id="min_rpm" value="100" type="number" data-export-key="min_rpm" data-export-section="rrv" />
                </label>
                <label>Max RPM:
                    <input class="input" id="max_rpm" value="2500" type="number" data-export-key="max_rpm" data-export-section="rrv" />
                </label>
              </div>
            </section>
        </div>
        
        <div class="flex flex-col gap-4">
            <section class="border-2 border-purple-600 rounded-xl p-3">
              <div class="flex justify-between items-center mb-2">
                <h2 class="bg-purple-700 text-white text-center rounded-md py-1 px-3 font-semibold">TORQUE CURVE</h2>
                <div class="flex gap-2">
                    <button id="importTorqueBtn" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded-md text-xs font-semibold">Import</button>
                    <button id="exportTorqueBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded-md text-xs font-semibold">Export</button>
                </div>
              </div>
              <div class="overflow-auto max-h-60">
                <table class="w-full text-sm">
                    <thead>
                        <tr>
                            <th class="font-semibold p-1 text-left">RPM</th>
                            <th class="font-semibold p-1 text-left">Torque (Nm)</th>
                            <th class="w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="torque_table_body">
                        </tbody>
                </table>
              </div>
              <button id="addTorqueRowBtn" class="mt-2 w-full text-sm bg-gray-200 hover:bg-gray-300 py-1 rounded">
                + Add Row
              </button>
            </section>
            
            <section class="border-2 border-blue-900 p-3 rounded-xl">
              <h2 class="text-blue-900 font-semibold text-lg mb-2">TRACTION SNAPSHOT</h2>
              <div class="grid grid-cols-1 gap-y-2">
                <span class="font-bold">Max Traction Produced:</span>
                <span id="res_traction_produced" class="font-semibold">- N</span>
                <span class="font-bold">Max Traction (No Slip):</span>
                <span id="res_traction_slipping" class="font-semibold">- N</span>
                <span class="font-bold">Result:</span>
                <span id="res_traction_result" class="font-bold text-lg text-gray-500">N/A</span>
              </div>
            </section>
            
            <div class="space-y-3 text-center p-4 border-2 border-gray-300 rounded-xl bg-gray-50 md:sticky md:top-4">
                <button id="calculateBtn" class="w-full bg-blue-700 hover:bg-blue-800 text-white px-4 py-3 rounded-lg font-semibold text-lg transition duration-300">
                  ðŸ“Š CALCULATE PERFORMANCE
                </button>
                <button id="saveDocBtn" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-semibold text-lg transition duration-300">
                  ðŸ’¾ SAVE DOCUMENT
                </button>
            </div>
            <pre id="errorBox" class="bg-red-50 p-3 rounded text-sm font-mono whitespace-pre-wrap text-red-700 hidden"></pre>
            
            <section class="border-2 border-gray-400 p-3 rounded-xl">
              <h2 class="text-gray-700 font-semibold text-lg mb-2">SPEED VS. SLOPE TABLE</h2>
              <div class="overflow-auto max-h-96">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="font-semibold p-2 text-left">Slope (%)</th>
                            <th class="font-semibold p-2 text-left">Max Achievable Speed (km/h)</th>
                        </tr>
                    </thead>
                    <tbody id="speed_slope_table_body">
                        <tr><td colspan="2" class="p-4 text-center text-gray-500">Click Calculate to see results...</td></tr>
                    </tbody>
                </table>
              </div>
            </section>
        </div>
        
        <div class="md:col-span-1 flex flex-col gap-4">
            <section class="border-2 border-gray-400 p-3 rounded-xl">
              <h2 class="text-gray-700 font-semibold text-lg mb-2">TRACTIVE EFFORT VS. SPEED</h2>
              <div class="h-[45vh]">
                  <canvas id="teChart"></canvas>
              </div>
            </section>
            
            <section class="border-2 border-gray-400 p-3 rounded-xl">
              <h2 class="text-gray-700 font-semibold text-lg mb-2">SHUNTING CAPABILITY VS. SPEED</h2>
              <div class="h-[45vh]">
                  <canvas id="scChart"></canvas>
              </div>
            </section>
        </div>
    </div>
  </div>

  <script>
    let lastInputData = null;
    
    // API URL Blank for automatic detection (Render friendly)
    const API_URL = ''; 
    
    // --- Chart.js Instances ---
    let teChartInstance = null;
    let scChartInstance = null;

    // --- DOM Elements ---
    const errorBox = document.getElementById('errorBox');
    const torqueTableBody = document.getElementById('torque_table_body');
    const addTorqueRowBtn = document.getElementById('addTorqueRowBtn');
    const csvFileInput = document.getElementById('csvFileInput');
    
    // Result spans
    const resTractionProduced = document.getElementById('res_traction_produced');
    const resTractionSlipping = document.getElementById('res_traction_slipping');
    const resTractionResult = document.getElementById('res_traction_result');
    
    // Result tables
    const speedSlopeTableBody = document.getElementById('speed_slope_table_body');

    // --- Torque Table Management ---
    function addTorqueRow(rpm = "", torque = "") {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="p-1"><input type="number" class="input torque-rpm" value="${rpm}" placeholder="RPM"></td>
            <td class="p-1"><input type="number" class="input torque-val" value="${torque}" placeholder="Torque"></td>
            <td class="p-1"><button class="text-red-500 hover:text-red-700 font-bold" onclick="removeTorqueRow(this)">Ã—</button></td>
        `;
        torqueTableBody.appendChild(row);
    }

    function removeTorqueRow(button) {
        button.closest('tr').remove();
    }

    function collectTorqueCurve() {
        const curve = {};
        const rpmInputs = document.querySelectorAll('.torque-rpm');
        const valInputs = document.querySelectorAll('.torque-val');
        
        for (let i = 0; i < rpmInputs.length; i++) {
            const rpm = parseInt(rpmInputs[i].value, 10);
            const torque = parseFloat(valInputs[i].value);
            if (!isNaN(rpm) && !isNaN(torque) && rpm > 0) {
                curve[rpm] = torque;
            }
        }
        return curve;
    }

    function populateTorqueTable(torqueData) {
        torqueTableBody.innerHTML = ""; // Clear existing
        if (!torqueData) return;
        
        // Handle both object {rpm: torque} and array [[rpm, torque], ...]
        let entries = [];
        if (Array.isArray(torqueData)) {
            entries = torqueData; // Assumes [rpm, torque]
        } else {
            entries = Object.entries(torqueData); // Converts {rpm: torque} to [[rpm, torque], ...]
        }
        
        entries.sort((a, b) => a[0] - b[0]); // Sort by RPM
        entries.forEach(([rpm, torque]) => {
            addTorqueRow(rpm, torque);
        });
    }
    
    // --- Function to collect all input data ---
    function collectRawData() {
        const rawData = { torque_curve: collectTorqueCurve() };
        // Collect all inputs with data-export-key
        document.querySelectorAll('[data-export-key]').forEach(el => {
            // Use the element's ID as the key
            rawData[el.id] = el.value;
        });
        return rawData;
    }
    
    // --- Clear Results ---
    function clearResults() {
        errorBox.textContent = "";
        errorBox.classList.add('hidden');
        resTractionProduced.textContent = "- N";
        resTractionSlipping.textContent = "- N";
        resTractionResult.textContent = "N/A";
        resTractionResult.className = "font-bold text-lg text-gray-500";
        speedSlopeTableBody.innerHTML = `<tr><td colspan="2" class="p-4 text-center text-gray-500">N/A</td></tr>`;
        
        if (teChartInstance) teChartInstance.destroy();
        if (scChartInstance) scChartInstance.destroy();
        teChartInstance = null;
        scChartInstance = null;
    }
    
    // --- API Call Function ---
    async function handleCalculateClick() {
      clearResults();
      const calculateBtn = document.getElementById('calculateBtn');
      calculateBtn.textContent = "Calculating...";
      calculateBtn.disabled = true;

      const rawData = collectRawData();

      try {
        const response = await fetch(`${API_URL}/calculate_performance`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(rawData),
        });

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.detail || "Unknown error");
        }

        // --- Update UI with new data ---
        
        // 1. Traction Snapshot
        const snapshot = data.traction_snapshot;
        resTractionProduced.textContent = `${snapshot.max_traction_generated_n.toFixed(2)} N`;
        resTractionSlipping.textContent = `${snapshot.max_traction_slipping_n.toFixed(2)} N`;
        resTractionResult.textContent = snapshot.result_message;
        resTractionResult.className = snapshot.result_message === "Limited by slipping" 
            ? "font-bold text-lg text-red-600" 
            : "font-bold text-lg text-green-600";

        // 2. Speed vs. Slope Table
        speedSlopeTableBody.innerHTML = ""; // Clear
        data.speed_vs_slope_table.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="p-2">${row.slope.toFixed(2)}</td>
                <td class="p-2">${row.max_speed_kmh.toFixed(2)}</td>
            `;
            speedSlopeTableBody.appendChild(tr);
        });

        // 3. Tractive Effort Graph
        teChartInstance = renderPlot('teChart', data.tractive_effort_graph, 'Speed (km/h)', 'Tractive Effort (N)');
        
        // 4. Shunting Capability Graph
        scChartInstance = renderPlot('scChart', data.shunting_capability_graph, 'Speed (km/h)', 'Shunting Capability (tons)');

        lastInputData = rawData; 
      } catch (error) {
        console.error("Fetch Error:", error);
        errorBox.textContent = `--- ERROR ---\n${error.message}`;
        errorBox.classList.remove('hidden');
        lastInputData = null;
      } finally {
        calculateBtn.textContent = "ðŸ“Š CALCULATE PERFORMANCE";
        calculateBtn.disabled = false;
      }
    }
    
    // --- Chart.js Rendering Function ---
    function renderPlot(canvasId, plotData, xLabel, yLabel) {
        const datasets = {};
        plotData.forEach(point => {
            const key = `Slope ${point.slope}% (Gear ${point.gear})`;
            if (!datasets[key]) {
                datasets[key] = {
                    label: key,
                    data: [],
                    borderColor: getRandomColor(point.slope),
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0
                };
            }
            datasets[key].data.push({ x: point.speed_kmh, y: point.value });
        });

        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, {
            type: 'line',
            data: {
                datasets: Object.values(datasets)
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'linear',
                        title: {
                            display: true,
                            text: xLabel
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: yLabel
                        },
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }

    const colorCache = {};
    function getRandomColor(slope) {
        if (colorCache[slope]) return colorCache[slope];
        
        let hash = 0;
        const strSlope = String(slope);
        for (let i = 0; i < strSlope.length; i++) {
            hash = strSlope.charCodeAt(i) + ((hash << 5) - hash);
        }
        let color = '#';
        for (let i = 0; i < 3; i++) {
            const value = (hash >> (i * 8)) & 0xFF;
            color += ('00' + value.toString(16)).substr(-2);
        }
        colorCache[slope] = color;
        return color;
    }

    // --- .docx download function ---
    async function handleSaveDocumentClick() {
        const saveDocBtn = document.getElementById('saveDocBtn');
        if (!lastInputData) {
            errorBox.textContent = "--- ERROR ---\nFirst, generate a successful report by clicking 'CALCULATE' button.";
            errorBox.classList.remove('hidden');
            return;
        }
        
        saveDocBtn.textContent = "Generating...";
        saveDocBtn.disabled = true;
        errorBox.classList.add('hidden');

        try {
            const response = await fetch(`${API_URL}/download_performance_report`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(lastInputData),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || "Failed to download file");
            }

            const blob = await response.blob();
            const contentDisposition = response.headers.get('content-disposition');
            let filename = "Vehicle_Performance_Report.docx"; 
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch && filenameMatch.length > 1) {
                    filename = filenameMatch[1];
                }
            }

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            
        } catch (error) {
            console.error("Download Error:", error);
            errorBox.textContent = `--- DOCUMENT DOWNLOAD ERROR ---\n${error.message}`;
            errorBox.classList.remove('hidden');
        } finally {
            saveDocBtn.textContent = "ðŸ’¾ SAVE DOCUMENT";
            saveDocBtn.disabled = false;
        }
    }

    // --- CSV Import/Export Functions ---

    function triggerDownload(content, filename, mimeType) {
        const a = document.createElement('a');
        const blob = new Blob([content], { type: mimeType });
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function exportInputsCSV() {
        let csvContent = "section,key,value\n";
        const rows = [];
        document.querySelectorAll('[data-export-key]').forEach(el => {
            const section = el.getAttribute('data-export-section');
            const key = el.getAttribute('data-export-key');
            const id_key = el.id; 
            const value = el.value.includes(',') ? `"${el.value}"` : el.value; 
            rows.push(`${section},${id_key},${value}`);
        });
        csvContent += rows.join('\n');
        triggerDownload(csvContent, 'vehicle_inputs.csv', 'text/csv;charset=utf-8;');
    }

    function importInputsCSV() {
        csvFileInput.onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const lines = text.split(/\r\n|\n/);
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    if (!line) continue;
                    const parts = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                    if (parts.length === 3) {
                        const key_from_csv = parts[1].replace(/"/g, ''); 
                        const value = parts[2].replace(/"/g, '');
                        const el = document.getElementById(key_from_csv);
                        if (el) el.value = value;
                    }
                }
            };
            reader.readAsText(file);
            csvFileInput.value = null;
        };
        csvFileInput.click();
    }

    function exportTorqueCSV() {
        let csvContent = "RPM,Torque\n";
        const torqueData = collectTorqueCurve();
        const rows = Object.entries(torqueData)
            .sort((a, b) => a[0] - b[0]) 
            .map(([rpm, torque]) => `${rpm},${torque}`);
        csvContent += rows.join('\n');
        triggerDownload(csvContent, 'torque_curve.csv', 'text/csv;charset=utf-8;');
    }

    function importTorqueCSV() {
        csvFileInput.onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const lines = text.split(/\r\n|\n/);
                const newTorqueData = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    if (!line) continue;
                    const parts = line.split(',');
                    if (parts.length === 2) {
                        const rpm = parseFloat(parts[0]);
                        const torque = parseFloat(parts[1]);
                        if (!isNaN(rpm) && !isNaN(torque)) {
                            newTorqueData.push([rpm, torque]);
                        }
                    }
                }
                populateTorqueTable(newTorqueData);
            };
            reader.readAsText(file);
            csvFileInput.value = null; 
        };
        csvFileInput.click();
    }

    // --- Event Listeners ---
    document.getElementById("calculateBtn").addEventListener("click", handleCalculateClick);
    document.getElementById("saveDocBtn").addEventListener("click", handleSaveDocumentClick);
    addTorqueRowBtn.addEventListener("click", () => addTorqueRow());
    document.getElementById("exportInputsBtn").addEventListener("click", exportInputsCSV);
    document.getElementById("importInputsBtn").addEventListener("click", importInputsCSV);
    document.getElementById("exportTorqueBtn").addEventListener("click", exportTorqueCSV);
    document.getElementById("importTorqueBtn").addEventListener("click", importTorqueCSV);

    // --- Initial Setup ---
    populateTorqueTable({
        100: 500,
        500: 800,
        1000: 1000,
        1500: 1100,
        2000: 900,
        2500: 700
    });
  </script>

  <style>
    .input { border: 1px solid #cbd5e1; border-radius: 6px; padding: 6px; width: 100%; margin-top: 4px; }
    .input:disabled { background-color: #f3f4f6; color: #9ca3af; }
    label { font-size: 0.875rem; font-weight: 500; color: #374151; display: block; }
  </style>
</body>
</html>